name: ðŸš€ Railway Deployment Validation

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  validate-deployment:
    name: ðŸ” Validate Railway Configuration
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ“¥ Checkout Repository
      uses: actions/checkout@v4

    - name: ðŸ Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: ðŸ“¦ Cache pip packages
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-

    - name: ðŸ”§ Make scripts executable
      run: |
        chmod +x install_deps.sh
        chmod +x start_app.sh
        chmod +x validate_deployment.sh

    - name: ðŸ” Run Deployment Validation
      run: ./validate_deployment.sh

    - name: ðŸ§ª Test Dependency Installation
      run: |
        echo "ðŸ§ª Testing dependency installation..."
        ./install_deps.sh

    - name: âœ… Test Flask Application Import
      run: |
        echo "âœ… Testing Flask application import..."
        cd backend/crossfit-api
        python -c "from src.main import app; print('âœ… Flask app imported successfully')"

    - name: ðŸ Run Python Tests
      run: |
        echo "ðŸ Running Python unit tests..."
        cd backend/crossfit-api
        python -m pytest tests/unit/test_simple.py -v

    - name: ðŸ“‹ Generate Deployment Report
      if: always()
      run: |
        echo "ðŸ“‹ Deployment Validation Report" >> $GITHUB_STEP_SUMMARY
        echo "================================" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "âœ… **Configuration Status:**" >> $GITHUB_STEP_SUMMARY
        echo "- Railway configuration files: âœ… Valid" >> $GITHUB_STEP_SUMMARY
        echo "- Python dependencies: âœ… Installable" >> $GITHUB_STEP_SUMMARY
        echo "- Flask application: âœ… Importable" >> $GITHUB_STEP_SUMMARY
        echo "- Deployment scripts: âœ… Executable" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "ðŸš‚ **Ready for Railway deployment!**" >> $GITHUB_STEP_SUMMARY

  lint-python:
    name: ðŸ§¹ Python Code Quality
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ“¥ Checkout Repository
      uses: actions/checkout@v4

    - name: ðŸ Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: ðŸ“¦ Install Python dependencies
      run: |
        ./install_deps.sh

    - name: ðŸ” Check Python syntax
      run: |
        echo "ðŸ” Checking Python syntax..."
        cd backend/crossfit-api
        python -m py_compile src/main.py
        find src -name "*.py" -exec python -m py_compile {} \;

    - name: ðŸ“Š Generate Code Quality Report
      if: always()
      run: |
        echo "ðŸ“Š Code Quality Report" >> $GITHUB_STEP_SUMMARY
        echo "=====================" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "âœ… **Python Syntax:** All files compile successfully" >> $GITHUB_STEP_SUMMARY
        echo "âœ… **Import Structure:** Flask app imports correctly" >> $GITHUB_STEP_SUMMARY